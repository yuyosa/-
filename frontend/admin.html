<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - Farm Game</title>
  <style>
    .user-card {
      border: 1px solid #ccc;
      margin: 10px;
      padding: 10px;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .inventory {
      margin-top: 5px;
      padding-left: 20px;
      display: none;
      border-left: 2px solid #aaa;
    }
    .btn {
      margin: 5px;
      padding: 4px 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>管理员面板</h1>
  <button onclick="loadAllUsers()">加载所有用户</button>

  <div id="user-list"></div>

<script>
  const API_BASE = "http://127.0.0.1:8000";

  // 加载所有用户
  async function loadAllUsers() {
    const container = document.getElementById('user-list');
    container.innerHTML = "加载中...";
    try {
      const resp = await fetch(`${API_BASE}/admin/users`);
      if (!resp.ok) {
        container.innerHTML = `错误: ${resp.status}`;
        return;
      }
      const users = await resp.json();
      if (!Array.isArray(users) || users.length === 0) {
        container.innerHTML = "暂无用户";
        return;
      }
      container.innerHTML = users.map(user => renderUserCard(user)).join('');
    } catch {
      container.innerHTML = "加载失败，请检查后端。";
    }
  }

  function renderUserCard(user) {
    return `<div class="user-card">
      <strong>${user.username}</strong> (ID: ${user.id})<br>
      密码: ${user.password}<br>
      金币: <input type="number" id="gold-${user.id}" value="${user.gold}" />
      <button onclick="updateGold(${user.id})">修改</button><br>
      等级: ${user.level}, 经验: ${user.xp}<br>
      <button class="btn" onclick="toggleInventory(${user.id})">查看库存</button>
      <div id="inventory-${user.id}" class="inventory"></div>
    </div>`;
  }

  async function toggleInventory(userId) {
    const invDiv = document.getElementById(`inventory-${userId}`);
    if (invDiv.style.display === "block") {
      invDiv.style.display = "none";
      return;
    }
    invDiv.style.display = "block";
    invDiv.textContent = "加载中...";
    try {
      const resp = await fetch(`${API_BASE}/inventory/${userId}`);
      if (!resp.ok) {
        invDiv.textContent = `错误: ${resp.status}`;
        return;
      }
      const inventory = await resp.json();
      if (!Array.isArray(inventory) || inventory.length === 0) {
        invDiv.textContent = "库存为空。";
        return;
      }
      invDiv.innerHTML = "<strong>库存：</strong><ul>" + inventory.map(i => `<li>${i.item_name} x${i.quantity}</li>`).join('') + "</ul>";
    } catch {
      invDiv.textContent = "加载失败。";
    }
  }

  async function updateGold(userId) {
    const newGold = document.getElementById(`gold-${userId}`).value;
    try {
      const resp = await fetch(`${API_BASE}/admin/update_gold/${userId}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({gold: parseInt(newGold)})
      });
      if (!resp.ok) {
        alert("修改失败");
        return;
      }
      alert("金币已更新");
    } catch {
      alert("请求失败");
    }
  }
</script>
</body>
</html>
