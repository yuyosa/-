<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - Farm Game</title>
  <style>
    .user-card {
      border: 1px solid #ccc;
      margin: 10px;
      padding: 10px;
    }
    .inventory {
      margin-top: 5px;
      padding-left: 20px;
      display: none;
      border-left: 2px solid #aaa;
    }
    .btn {
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>

  <p>请输入用户ID查看用户数据（多次查看可刷新）</p>
  <input type="number" id="userIdInput" placeholder="User ID" />
  <button onclick="loadUser()">加载用户数据</button>

  <div id="user-list"></div>

<script>
  const API_BASE = "http://127.0.0.1:8000";

  async function loadUser() {
    const userId = document.getElementById('userIdInput').value.trim();
    if (!userId) {
      alert("请输入有效用户ID");
      return;
    }
    const container = document.getElementById('user-list');
    container.innerHTML = '加载中...';

    try {
      const resp = await fetch(`${API_BASE}/state/${userId}`);
      if (!resp.ok) {
        container.innerHTML = `错误: ${resp.status} ${resp.statusText}`;
        return;
      }
      const user = await resp.json();

      let html = `<div class="user-card">
        <strong>${user.username}</strong> (ID: ${userId})<br>
        黄金: ${user.gold}<br>
        等级: ${user.level}, 经验: ${user.xp}<br>
        <h4>农田:</h4>
        <ul>
          ${user.plots.map(p => `<li>Plot ${p.id}: ${p.crop || '空地'}${p.planted_at ? ` (种植时间: ${p.planted_at})` : ''}</li>`).join('')}
        </ul>
        <button class="btn" onclick="toggleInventory(${userId})">查看库存</button>
        <div id="inventory-${userId}" class="inventory"></div>
      </div>`;

      container.innerHTML = html;

    } catch (e) {
      container.innerHTML = "加载失败，请检查网络和后端服务";
    }
  }

  async function toggleInventory(userId) {
    const invDiv = document.getElementById(`inventory-${userId}`);
    if (invDiv.style.display === "block") {
      invDiv.style.display = "none";
      return;
    }
    invDiv.style.display = "block";
    invDiv.textContent = "加载中...";
    try {
      const resp = await fetch(`${API_BASE}/inventory/${userId}`);
      if (!resp.ok) {
        invDiv.textContent = `错误: ${resp.status}`;
        return;
      }
      const inventory = await resp.json();
      if (!Array.isArray(inventory) || inventory.length === 0) {
        invDiv.textContent = "库存为空。";
        return;
      }
      invDiv.innerHTML = "<strong>库存：</strong><ul>" + inventory.map(i => `<li>${i.item_name} x${i.quantity}</li>`).join('') + "</ul>";
    } catch {
      invDiv.textContent = "加载失败。";
    }
  }
</script>

</body>
</html>
